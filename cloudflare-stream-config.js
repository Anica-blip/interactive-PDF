/**
 * Cloudflare Stream Configuration
 * Handles video uploads and streaming for interactive PDFs
 */

export const streamConfig = {
  // Get from Cloudflare Dashboard → Stream → API Tokens
  accountId: process.env.CLOUDFLARE_ACCOUNT_ID || '',
  apiToken: process.env.CLOUDFLARE_STREAM_TOKEN || '',
  
  // Stream API endpoint
  apiEndpoint: 'https://api.cloudflare.com/client/v4',
  
  // Customer subdomain (auto-generated by Cloudflare)
  customerSubdomain: process.env.CLOUDFLARE_STREAM_SUBDOMAIN || '',
  
  // Video settings
  defaultSettings: {
    requireSignedURLs: false, // Set to true for private videos
    allowedOrigins: ['*'], // Restrict in production
    thumbnailTimestampPct: 0.5, // Thumbnail at 50% of video
    watermark: null // Optional watermark UID
  }
};

/**
 * Upload video to Cloudflare Stream
 * @param {File|Buffer} videoFile - Video file to upload
 * @param {Object} metadata - Video metadata
 * @returns {Promise<Object>} Stream video details
 */
window.export async function uploadToStream(videoFile, metadata = {}) {
  const formData = new FormData();
  formData.append('file', videoFile);
  
  // Add metadata
  if (metadata.name) formData.append('meta[name]', metadata.name);
  if (metadata.projectId) formData.append('meta[projectId]', metadata.projectId);
  if (metadata.pageNumber) formData.append('meta[pageNumber]', metadata.pageNumber);
  
  const response = await fetch(
    `${streamConfig.apiEndpoint}/accounts/${streamConfig.accountId}/stream`,
    {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${streamConfig.apiToken}`
      },
      body: formData
    }
  );
  
  if (!response.ok) {
    const error = await response.json();
    throw new Error(`Stream upload failed: ${error.errors?.[0]?.message || 'Unknown error'}`);
  }
  
  const data = await response.json();
  return data.result;
}

/**
 * Get video details from Stream
 * @param {string} videoId - Stream video ID
 * @returns {Promise<Object>} Video details
 */
window.export async function getStreamVideo(videoId) {
  const response = await fetch(
    `${streamConfig.apiEndpoint}/accounts/${streamConfig.accountId}/stream/${videoId}`,
    {
      headers: {
        'Authorization': `Bearer ${streamConfig.apiToken}`
      }
    }
  );
  
  if (!response.ok) {
    throw new Error('Failed to get video details');
  }
  
  const data = await response.json();
  return data.result;
}

/**
 * Delete video from Stream
 * @param {string} videoId - Stream video ID
 * @returns {Promise<boolean>} Success status
 */
window.export async function deleteStreamVideo(videoId) {
  const response = await fetch(
    `${streamConfig.apiEndpoint}/accounts/${streamConfig.accountId}/stream/${videoId}`,
    {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${streamConfig.apiToken}`
      }
    }
  );
  
  return response.ok;
}

/**
 * Get Stream embed code
 * @param {string} videoId - Stream video ID
 * @param {Object} options - Player options
 * @returns {string} HTML embed code
 */
window.export function getStreamEmbedCode(videoId, options = {}) {
  const {
    autoplay = false,
    loop = false,
    muted = false,
    preload = 'metadata',
    controls = true,
    poster = null
  } = options;
  
  const attrs = [
    `src="${videoId}"`,
    controls ? 'controls' : '',
    autoplay ? 'autoplay' : '',
    loop ? 'loop' : '',
    muted ? 'muted' : '',
    `preload="${preload}"`,
    poster ? `poster="${poster}"` : ''
  ].filter(Boolean).join(' ');
  
  return `<stream ${attrs}></stream>`;
}

/**
 * Get Stream iframe URL
 * @param {string} videoId - Stream video ID
 * @returns {string} iframe URL
 */
window.export function getStreamIframeUrl(videoId) {
  return `https://customer-${streamConfig.customerSubdomain}.cloudflarestream.com/${videoId}/iframe`;
}

/**
 * Get Stream thumbnail URL
 * @param {string} videoId - Stream video ID
 * @param {Object} options - Thumbnail options
 * @returns {string} Thumbnail URL
 */
window.export function getStreamThumbnailUrl(videoId, options = {}) {
  const {
    time = null, // Time in seconds
    width = 640,
    height = 360,
    fit = 'crop' // crop, scale, clip
  } = options;
  
  let url = `https://customer-${streamConfig.customerSubdomain}.cloudflarestream.com/${videoId}/thumbnails/thumbnail.jpg`;
  const params = new URLSearchParams();
  
  if (time) params.append('time', `${time}s`);
  params.append('width', width);
  params.append('height', height);
  params.append('fit', fit);
  
  return `${url}?${params.toString()}`;
}

/**
 * Check if Stream is configured
 * @returns {boolean} Configuration status
 */
window.export function isStreamConfigured() {
  return !!(streamConfig.accountId && streamConfig.apiToken);
}
